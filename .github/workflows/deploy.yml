name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # JOB 1: Basic Quality Checks (non-blocking)
  quality-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install validation tools
        run: npm install -g html-validate

      - name: Validate HTML syntax (warnings only)
        run: |
          echo "üîç Checking HTML syntax..."
          for file in *.html; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              html-validate "$file" || echo "‚ö†Ô∏è  $file has some issues (non-blocking)"
            fi
          done
        continue-on-error: true

      - name: Check for critical issues only
        run: |
          echo "üîç Checking for CRITICAL issues..."
          
          critical_errors=0
          
          # Check for missing images (actual files)
          echo "Checking for missing local images..."
          for file in *.html; do
            if [ -f "$file" ]; then
              # Extract image src that are local files (not URLs)
              grep -oP 'src="\K[^"]+' "$file" 2>/dev/null | while read -r src; do
                if [[ "$src" =~ ^https?:// ]] || [[ "$src" =~ ^data: ]] || [[ "$src" =~ ^# ]]; then
                  continue
                fi
                if [ ! -f "$src" ]; then
                  echo "‚ùå CRITICAL: Missing image - $src (in $file)"
                  critical_errors=1
                fi
              done
            fi
          done
          
          # Check for unclosed critical tags (html, head, body)
          echo "Checking for unclosed critical HTML tags..."
          for file in *.html; do
            if [ -f "$file" ]; then
              if ! grep -q "</html>" "$file"; then
                echo "‚ùå CRITICAL: Missing </html> in $file"
                critical_errors=1
              fi
              if grep -q "<head>" "$file" && ! grep -q "</head>" "$file"; then
                echo "‚ùå CRITICAL: Unclosed <head> in $file"
                critical_errors=1
              fi
              if grep -q "<body>" "$file" && ! grep -q "</body>" "$file"; then
                echo "‚ùå CRITICAL: Unclosed <body> in $file"
                critical_errors=1
              fi
            fi
          done
          
          if [ $critical_errors -eq 1 ]; then
            echo ""
            echo "‚ùå CRITICAL ERRORS FOUND - Deployment blocked"
            exit 1
          fi
          
          echo "‚úÖ No critical issues found - safe to deploy"

      - name: List files to be deployed
        run: |
          echo "üì¶ Files ready for deployment:"
          ls -lh *.html *.css 2>/dev/null || echo "HTML/CSS files ready"

  # JOB 2: Build (only runs if quality-checks pass)
  build:
    runs-on: ubuntu-latest
    needs: quality-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  # JOB 3: Deploy (only runs if build passes)
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment complete
        run: |
          echo "‚úÖ Site deployed successfully!"
          echo "üåê URL: ${{ steps.deployment.outputs.page_url }}"
